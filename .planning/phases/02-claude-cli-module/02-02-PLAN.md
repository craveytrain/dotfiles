---
phase: 02-claude-cli-module
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - playbooks/deploy.yml
autonomous: false

must_haves:
  truths:
    - "Claude module added to deploy.yml"
    - "Deployment runs without errors"
    - "Symlinks created in ~/.claude/"
    - "Claude Code recognizes synced configuration"
  artifacts:
    - path: "playbooks/deploy.yml"
      provides: "Deployment playbook with claude module"
      contains: "- claude"
  key_links:
    - from: "playbooks/deploy.yml"
      to: "modules/claude/"
      via: "dotmodules.install list"
      pattern: "install:.*claude"
    - from: "~/.claude/agents"
      to: "modules/claude/files/.claude/agents"
      via: "GNU Stow symlink"
---

<objective>
Deploy Claude module and verify configuration sync

Purpose: Add the Claude module to the deployment playbook, run deployment, and verify that the synced configuration is recognized by Claude Code.

Output: Working Claude CLI with synchronized agents, commands, and GSD workflow
</objective>

<execution_context>
@/Users/mcravey/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mcravey/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-claude-cli-module/02-RESEARCH.md
@.planning/phases/02-claude-cli-module/02-01-SUMMARY.md
@playbooks/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add claude module to deploy.yml</name>
  <files>playbooks/deploy.yml</files>
  <action>
Add the claude module to the playbooks/deploy.yml install list.

1. Read current deploy.yml
2. Add `- claude` to the dotmodules.install list (after ghostty is fine)
3. Write updated deploy.yml

The install list should now include:
- git
- fonts
- 1password
- shell
- fish
- zsh
- dev-tools
- node
- editor
- ghostty
- claude  # NEW
  </action>
  <verify>
    - `grep "- claude" playbooks/deploy.yml` returns the line
    - `ansible-playbook --syntax-check playbooks/deploy.yml` passes
  </verify>
  <done>deploy.yml updated with claude module in install list, syntax validated</done>
</task>

<task type="auto">
  <name>Task 2: Deploy module with Ansible</name>
  <files>None (deployment only)</files>
  <action>
Run the Ansible deployment playbook with --skip-tags register_shell to avoid sudo requirement.

IMPORTANT: Before deployment, need to handle potential Stow conflicts. The ~/.claude directory already exists with files that will conflict with Stow.

Strategy:
1. First, back up any files in ~/.claude that would conflict but aren't synced:
   - ~/.claude/settings.local.json (keep - machine specific)
   - ~/.claude/history.jsonl (keep - session data)
   - ~/.claude/hooks/ (keep - has local paths)
   - etc.

2. For files we ARE syncing, they will be replaced by symlinks. This may require removing existing files first:
   - rm ~/.claude/settings.json (will be symlinked)
   - rm -rf ~/.claude/agents/ (will be symlinked)
   - rm -rf ~/.claude/commands/ (will be symlinked)
   - rm -rf ~/.claude/get-shit-done/ (will be symlinked)

3. Run deployment:
   ```bash
   ansible-playbook -i playbooks/inventory playbooks/deploy.yml --skip-tags register_shell
   ```

NOTE: If Stow reports conflicts, you may need to use `stow --adopt` first to adopt existing files into the module, then reset the module files from git.

Alternative approach if conflicts are problematic:
```bash
cd ~/.dotmodules/claude
stow --adopt -t ~ claude
cd ~/dotfiles/modules/claude/files
git checkout .
```
  </action>
  <verify>
    - Deployment completes without errors
    - `ls -la ~/.claude/agents` shows symlink to .dotmodules
    - `ls -la ~/.claude/commands` shows symlink to .dotmodules
    - `ls -la ~/.claude/get-shit-done` shows symlink to .dotmodules
    - `ls -la ~/.claude/settings.json` shows symlink to .dotmodules
  </verify>
  <done>Claude module deployed with symlinks created for agents, commands, get-shit-done, and settings.json</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Claude CLI module with synchronized configuration:
- Custom agents (gsd-planner, gsd-executor, etc.)
- Custom slash commands (/gsd:*)
- GSD workflow framework
- Portable settings.json
  </what-built>
  <how-to-verify>
1. Open a NEW terminal window (to pick up any changes)

2. Verify symlinks exist:
   ```bash
   ls -la ~/.claude/agents
   ls -la ~/.claude/commands
   ls -la ~/.claude/get-shit-done
   ```
   Should show symlinks pointing to ~/.dotmodules/claude/...

3. Verify Claude Code works:
   ```bash
   claude --version
   ```
   Should show version (confirms installation)

4. Verify commands are available:
   - Start Claude in any directory: `claude`
   - Type `/gsd:help` - should show GSD help
   - Type `exit` to quit

5. Verify agents load:
   - In Claude, check that spawning an agent works (no need to run, just confirm no errors)

Expected: Claude Code launches, recognizes synced commands and agents
  </how-to-verify>
  <resume-signal>Type "approved" if Claude Code works with synced config, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
End-to-end verification:
- deploy.yml contains claude module
- Ansible deployment succeeded
- Symlinks exist: ~/.claude/{agents,commands,get-shit-done,settings.json} -> .dotmodules
- Claude Code launches without errors
- /gsd: commands accessible
- Human verified functionality
</verification>

<success_criteria>
- playbooks/deploy.yml includes claude in install list
- Deployment completes without errors
- Symlinks created for all synced directories
- Claude Code recognizes synced configuration
- User confirms /gsd: commands work
</success_criteria>

<output>
After completion, create `.planning/phases/02-claude-cli-module/02-02-SUMMARY.md`
</output>
